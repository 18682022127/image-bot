{
  "name": "Img2Img-Production-V2",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "bcdedd02-3c79-4408-a0be-51606c153db6",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -880,
        416
      ],
      "webhookId": "img2img-production-webhook",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "check-photo-bool",
              "leftValue": "={{ !!$json.message.photo }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "32149e0b-95a3-454b-b011-b00ac49311d8",
      "name": "Is Photo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -656,
        416
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. æå– FastAPI è¿”å›çš„ Base64\nconst b64 = items[0].json.data[0].b64_json;\n\n// 2. è½¬å›äºŒè¿›åˆ¶æµ\nconst binaryData = Buffer.from(b64, 'base64');\n\n// 3. è·å–åŸå§‹æ¶ˆæ¯ ID (ç”¨äºå›å¤)\nconst triggerMsg = $('Telegram Trigger').first().json.message;\n\nreturn [{\n  json: {\n    chat_id: triggerMsg.chat.id,\n    message_id: triggerMsg.message_id,\n    caption: \"ğŸ¨ å›¾ç”Ÿå›¾é‡ç»˜å®Œæˆ!\"\n  },\n  binary: {\n    image: {\n      data: b64,\n      mimeType: 'image/png',\n      fileName: 'generated_result.png'\n    }\n  }\n}];"
      },
      "id": "8dc5e3d7-7541-41eb-b4e9-f2fb01c88a3e",
      "name": "Process Base64",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        384
      ]
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $json.chat_id }}",
        "binaryData": true,
        "binaryPropertyName": "image",
        "additionalFields": {
          "caption": "={{ $json.caption }}",
          "reply_to_message_id": "={{ $json.message_id }}"
        }
      },
      "id": "45860e1b-f2f2-4a1f-ab18-c2c7887bd069",
      "name": "Send Result",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        464,
        384
      ],
      "webhookId": "968114bc-8fc4-4f67-b859-67b23c5fa302",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://10.126.3.102:8000/v1/images/img2img",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sk-comfyui-z-image-turbo"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $('Telegram Trigger').item.json.message.caption || \"high quality, detailed\" }}"
            },
            {
              "name": "strength",
              "value": "0.6"
            },
            {
              "name": "n",
              "value": "1"
            },
            {
              "parameterType": "formBinaryData",
              "name": "image",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "7d85c1c0-f82d-4eec-8e96-9f729ad264f3",
      "name": "Call FastAPI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -32,
        416
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.photo[$json.message.photo.length - 1].file_id }}",
        "additionalFields": {
          "mimeType": "image/jpeg"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -416,
        208
      ],
      "id": "961a0e17-3678-4008-8b2b-51bc26851311",
      "name": "Get a file",
      "webhookId": "931eb25e-1588-405a-b3b9-c28f166c2de3",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. è·å– Trigger é‡Œçš„æç¤ºè¯ (JSONéƒ¨åˆ†)\nconst triggerNode = $('Telegram Trigger').first();\n// è·å– Captionï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤å€¼\nconst caption = triggerNode.json.message.caption || \"enhance image\";\n\n// 2. è·å– Download Photo é‡Œçš„â€œæ–‡ä»¶å‡­è¯â€ (Binaryéƒ¨åˆ†)\n// è¿™é‡Œçš„ .binary.data å°±æ˜¯ä½ çœ‹åˆ°çš„é‚£ä¸ªåŒ…å« { mimeType:..., data: 'filesystem-v2' } çš„å¯¹è±¡\nconst binaryObject = $('Get a file').first().binary.data;\n\n// 3. æ£€æŸ¥å‡­è¯æ˜¯å¦å­˜åœ¨\nif (!binaryObject) {\n  throw new Error(\"âŒ æ²¡æ‰¾åˆ°æ–‡ä»¶å‡­è¯ï¼è¯·æ£€æŸ¥ Download Photo èŠ‚ç‚¹çš„ 'Put Output File in Field' æ˜¯å¦å¡«äº† 'data'\");\n}\n\n// 4. ã€å…³é”®æ­¥éª¤ã€‘ç›´æ¥æŠŠå‡­è¯ä¼ ä¸‹å»ï¼\n// ä¸è¦è¯»æ–‡ä»¶ï¼Œä¸è¦è½¬ Base64ï¼Œç›´æ¥ä¼ å¯¹è±¡\nreturn {\n  json: {\n    prompt: caption,\n    strength: 0.6,\n    n: 1\n  },\n  binary: {\n    // è¿™é‡ŒæŠŠå‡­è¯å¯¹è±¡èµ‹ç»™ key ä¸º 'data' çš„å±æ€§\n    // ä¸‹ä¸€ä¸ª HTTP èŠ‚ç‚¹ä¼šé€šè¿‡ 'data' è¿™ä¸ª key æ‰¾åˆ°å‡­è¯ï¼Œç„¶åè‡ªåŠ¨å»ç¡¬ç›˜è¯»æ–‡ä»¶\n    data: binaryObject\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        208
      ],
      "id": "cdf7bea3-26bd-4367-a0b7-51727ddbb8c8",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Is Photo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Photo?": {
      "main": [
        [
          {
            "node": "Get a file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Base64": {
      "main": [
        [
          {
            "node": "Send Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call FastAPI": {
      "main": [
        [
          {
            "node": "Process Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a file": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Call FastAPI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "6bdd0900-220b-49b1-bb28-f145d3116922",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ddaf392637b206c3ca35cb59af8832c68e4fb30d5aa89f58f86f6c1d64e88ff6"
  },
  "id": "2gjK9NCNcX2WAPf8",
  "tags": []
}