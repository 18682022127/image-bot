{
  "name": "Group Bot Master V4 (Strict)",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "a2c9766e-904d-4362-8d5f-f604e997af42",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -832,
        256
      ],
      "webhookId": "group-master-v4",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// åˆå§‹åŒ–å˜é‡\nconst msg = $('Telegram Trigger').item.json.message;\nconst chatType = msg.chat.type; // 'private', 'group', 'supergroup'\nlet prompt = \"\";\nlet imageFileId = null;\nlet actionType = \"ignore\"; // 'txt2img', 'img2img', 'error_missing_prompt', 'ignore'\n\n// âš ï¸ è¯·ä¿®æ”¹è¿™é‡Œï¼šä½ çš„æœºå™¨äººç”¨æˆ·å (ä¸å¸¦@)\nconst BOT_USERNAME = \"z_mindjourey_bot\"; \n\n// --- é€»è¾‘åˆ¤æ–­æ ¸å¿ƒ ---\n\n// 1. è·å–æ–‡æœ¬å†…å®¹ (å¯èƒ½æ˜¯ text æˆ–è€…æ˜¯ caption)\nlet fullText = msg.text || msg.caption || \"\";\n\n// 2. åˆ¤æ–­æ˜¯å¦è¢« @ (ç¾¤ç»„ä¸­å¿…é¡»è¢« @ æˆ–è€…æ˜¯å›å¤æœºå™¨äººï¼Œæˆ–è€…æ˜¯ç§èŠ)\nconst isPrivate = chatType === 'private';\nconst hasMention = fullText.includes('@' + BOT_USERNAME);\nconst isReplyToBot = msg.reply_to_message && msg.reply_to_message.from.username === BOT_USERNAME;\n\n// å¦‚æœæ˜¯ç¾¤ç»„ï¼Œä¸”æ²¡æœ‰ @ ä¹Ÿæ²¡æœ‰å›å¤æœºå™¨äººï¼Œç›´æ¥å¿½ç•¥\nif (!isPrivate && !hasMention && !isReplyToBot) {\n  return { json: { actionType: \"ignore\" } };\n}\n\n// 3. æ¸…ç†å…³é”®è¯ï¼Œæå– Prompt\n// ç§»é™¤ @username å’Œ \"ç”»å›¾ï¼š\" ç­‰å‰ç¼€\nprompt = fullText.replace('@' + BOT_USERNAME, '')\n                 .replace('ç”»å›¾ï¼š', '')\n                 .replace('ç”»å›¾:', '')\n                 .trim();\n\n// 4. åˆ¤æ–­ä»»åŠ¡ç±»å‹\n\n// æƒ…å†µ A: æ¶ˆæ¯æœ¬èº«å°±æ˜¯ä¸€å¼ å›¾ (ç§èŠç›´æ¥å‘å›¾ï¼Œæˆ–ç¾¤é‡Œå‘å›¾å¸¦caption)\nif (msg.photo) {\n  actionType = \"img2img\";\n  imageFileId = msg.photo[msg.photo.length - 1].file_id;\n}\n\n// æƒ…å†µ B: æ¶ˆæ¯æ˜¯æ–‡å­—ï¼Œä½†æ˜¯ã€å›å¤ã€‘äº†ä¸€å¼ å›¾ (ç¾¤é‡Œå›å¤å›¾ç‰‡)\nelse if (msg.reply_to_message && msg.reply_to_message.photo) {\n  actionType = \"img2img\";\n  const replyPhotos = msg.reply_to_message.photo;\n  imageFileId = replyPhotos[replyPhotos.length - 1].file_id;\n}\n\n// æƒ…å†µ C: åªæœ‰æ–‡å­— (æ–‡ç”Ÿå›¾)\nelse if (prompt.length > 0) {\n  actionType = \"txt2img\";\n}\n\n// 5. ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶æ ¡éªŒå›¾ç”Ÿå›¾çš„æç¤ºè¯\nif (actionType === 'img2img' && prompt.length === 0) {\n  actionType = 'error_missing_prompt';\n}\n\nreturn {\n  json: {\n    actionType,\n    prompt,\n    imageFileId,\n    chatId: msg.chat.id,\n    messageId: msg.message_id\n  }\n};\n"
      },
      "id": "932a55ec-a5a7-4948-8c06-c2c38e09ff7c",
      "name": "æ™ºèƒ½é€»è¾‘è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        256
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.actionType }}",
        "rules": {
          "rules": [
            {
              "value2": "txt2img"
            },
            {
              "value2": "img2img",
              "output": 1
            },
            {
              "value2": "error_missing_prompt",
              "output": 2
            }
          ]
        },
        "fallbackOutput": 3
      },
      "id": "26620eaa-cb59-4467-8c83-99b6f2acdbb8",
      "name": "ä»»åŠ¡è·¯ç”±",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        -384,
        256
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://z-service-fastapi:8000/v1/images/generations",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sk-comfyui-z-image-turbo"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "n",
              "value": "1"
            },
            {
              "name": "size",
              "value": "1024x1024"
            }
          ]
        },
        "options": {}
      },
      "id": "9cb51640-92d0-4895-a023-7ad953fc7b10",
      "name": "è°ƒç”¨æ–‡ç”Ÿå›¾ API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -128,
        48
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.imageFileId }}",
        "additionalFields": {}
      },
      "id": "ddf98395-38b2-462b-b25a-5294a701cb89",
      "name": "ä¸‹è½½å›¾ç‰‡",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -144,
        288
      ],
      "webhookId": "706bc30c-5ffe-408b-8b9c-6a073bc2db6a",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ä¼ é€’æ•°æ®ç»™ HTTP Request\nconst jsonInput = $('æ™ºèƒ½é€»è¾‘è§£æ').first().json;\nconst binaryData = items[0].binary.data;\n\nreturn {\n  json: {\n    prompt: jsonInput.prompt,\n    strength: 0.6,\n    n: 1\n  },\n  binary: {\n    data: binaryData\n  }\n};"
      },
      "id": "9e82fc07-c5ba-4669-85b2-ce45aed754a2",
      "name": "å‡†å¤‡å›¾ç”Ÿå›¾æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        288
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://z-service-fastapi:8000/v1/images/img2img",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer sk-comfyui-z-image-turbo"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "strength",
              "value": "0.6"
            },
            {
              "parameterType": "formBinaryData",
              "name": "image",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "id": "f56ab4d5-5ed5-4ddb-837a-73992879088c",
      "name": "è°ƒç”¨å›¾ç”Ÿå›¾ API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        256,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const b64 = items[0].json.data[0].b64_json;\nconst origin = $('æ™ºèƒ½é€»è¾‘è§£æ').first().json;\n\nreturn [{\n  json: {\n    chat_id: origin.chatId,\n    message_id: origin.messageId,\n    caption: \"ğŸ¨ ç»˜åˆ¶å®Œæˆ!\"\n  },\n  binary: {\n    image: {\n      data: b64,\n      mimeType: 'image/png',\n      fileName: 'result.png'\n    }\n  }\n}];"
      },
      "id": "944b4a16-540d-4cbb-a9c3-ba597002bf8b",
      "name": "å¤„ç†è¿”å›ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        208
      ]
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $json.chat_id }}",
        "binaryData": true,
        "binaryPropertyName": "image",
        "additionalFields": {
          "caption": "={{ $json.caption }}",
          "reply_to_message_id": "={{ $json.message_id }}"
        }
      },
      "id": "690e7171-cf83-4d30-b68e-91b25fe6f0c4",
      "name": "å‘é€å›¾ç‰‡",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        736,
        208
      ],
      "webhookId": "1ff2be3b-56cc-4d2f-aae1-b8fcc9584454",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "âš ï¸ **æ“ä½œæç¤º**\n\nå›¾ç”Ÿå›¾å¿…é¡»æä¾›è¯´æ˜\n\nğŸ”¹ **ç§èŠ**ï¼šè¯·åœ¨å‘é€å›¾ç‰‡æ—¶ï¼Œåœ¨â€œæ·»åŠ è¯´æ˜â€å¤„è¾“å…¥æç¤ºè¯ã€‚\nğŸ”¹ **ç¾¤èŠ**ï¼šè¯·å›å¤å›¾ç‰‡å¹¶æ·»åŠ æ¶ˆæ¯æ–‡æœ¬",
        "additionalFields": {
          "appendAttribution": false,
          "reply_to_message_id": "={{ $json.messageId }}"
        }
      },
      "id": "10c4311a-4608-4088-947f-726ce19fb533",
      "name": "å‘é€é”™è¯¯æç¤º",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -144,
        512
      ],
      "webhookId": "2a9cddbb-5aa8-4aa6-a2d3-843d4c49dbe4",
      "credentials": {
        "telegramApi": {
          "id": "KwAzFRET7KeFoHlA",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "æ™ºèƒ½é€»è¾‘è§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ™ºèƒ½é€»è¾‘è§£æ": {
      "main": [
        [
          {
            "node": "ä»»åŠ¡è·¯ç”±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»»åŠ¡è·¯ç”±": {
      "main": [
        [
          {
            "node": "è°ƒç”¨æ–‡ç”Ÿå›¾ API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ä¸‹è½½å›¾ç‰‡",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å‘é€é”™è¯¯æç¤º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è°ƒç”¨æ–‡ç”Ÿå›¾ API": {
      "main": [
        [
          {
            "node": "å¤„ç†è¿”å›ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹è½½å›¾ç‰‡": {
      "main": [
        [
          {
            "node": "å‡†å¤‡å›¾ç”Ÿå›¾æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡å›¾ç”Ÿå›¾æ•°æ®": {
      "main": [
        [
          {
            "node": "è°ƒç”¨å›¾ç”Ÿå›¾ API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è°ƒç”¨å›¾ç”Ÿå›¾ API": {
      "main": [
        [
          {
            "node": "å¤„ç†è¿”å›ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†è¿”å›ç»“æœ": {
      "main": [
        [
          {
            "node": "å‘é€å›¾ç‰‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3004cd45-f88a-4b62-88b4-81bcd02411ab",
  "meta": {
    "instanceId": "ddaf392637b206c3ca35cb59af8832c68e4fb30d5aa89f58f86f6c1d64e88ff6"
  },
  "id": "51qLWr3p7J6jUmRt",
  "tags": []
}